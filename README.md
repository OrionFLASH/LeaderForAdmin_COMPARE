---

## Назначение

**Этот скрипт предназначен для автоматического сравнения и анализа изменений в списках лидеров по двум версиям исходных JSON-файлов турниров.**
Результатом работы является Excel-файл с подробным сравнением (все отличия, статусы изменений, цветовая индикация) и лог-файл с описанием процесса.

---

## Описание процесса

1. **Загрузка данных**

   * Принимает на вход два JSON-файла (до и после изменений).
   * Пути к файлам задаются в начале или через параметры.
2. **Парсинг**

   * Строит плоскую таблицу лидеров по каждому турниру.
   * Все вложенные структуры (например, `divisionRatings`) преобразуются в отдельные колонки с префиксами.
   * Числовые поля переводятся в float/int (устойчиво к форматам).
3. **Формирование единой структуры**

   * Колонки обеих таблиц выравниваются (пропущенные добавляются).
   * Ключ: уникальная пара `(tournamentId, employeeNumber)`.
4. **Сравнение**

   * Находит всех уникальных участников.
   * Для каждой пары рассчитывает статусы изменений по ключевым полям.
   * Для всех полей с рейтингами формируется специальный статус (`NEW`, `REMOVE`, `NO CHANGE`, `UP`, `DOWN`, `NO_RANK` и др.).
   * Для категорий призёра сравнивается переход в/из призовых, ухудшения/улучшения и др.
5. **Фильтрация**

   * Оставляются только строки, где **хотя бы в одном статусном поле есть изменение** (не "нет изменений").
   * Исключение строк, где во всех статусных полях только "нулевые" значения (`No Change`, `STAYED_OUT`, `PRIZE_UNCHANGED`, `NO_RANK` и др.).
   * Можно дополнительно фильтровать по нужным турнирам через параметр.
6. **Выгрузка**

   * Все этапы логируются (в файл/консоль).
   * В Excel формируется 3 листа: "BEFORE", "AFTER", "COMPARE".
   * Цветовая индикация статусов (`STATUS_COLORS_DICT`).
   * В лог пишется количество строк на каждом этапе и уникальные значения по статусам.

---

## Основные функции

* **parse\_json\_file(filepath)**
  Парсит JSON-файл, строит плоскую таблицу лидеров (одна строка — один участник турнира).
  Обрабатывает вложенные структуры (`divisionRatings`), отсутствующие и ошибочные поля, добавляет заглушки при отсутствии лидеров.

* **flatten\_leader(leader, tournament, source\_file)**
  Разворачивает участника турнира в одну плоскую строку, распаковывая вложенные группы.

* **align\_columns(df1, df2)**
  Делает список столбцов в двух таблицах одинаковым (важно для дальнейшего сравнения).

* **make\_compare\_sheet(df\_before, df\_after, sheet\_name)**
  Формирует итоговую таблицу сравнения:

  * Строит объединённый DataFrame всех уникальных участников.
  * Для каждого ключевого поля считает статус изменения (например, выросло/упало/не изменилось/исчезло/добавилось/нет рейтинга).
  * Для категорий призёра учитывает вход/выход из призовых, смену категории.
  * Проставляет новый статус `"NO_RANK"`, если рейтинг отсутствует в обеих версиях.
  * Логирует число строк до/после каждого этапа, статистику по статусам.
  * Фильтрует строки: в COMPARE попадают только те, где есть **хоть одно** реальное изменение.
  * Возвращает итоговую таблицу и имя листа.

* **main()**
  Запускает все этапы, логирует статус обработки, сохраняет итоговый Excel-файл.

---

## Ключевые параметры и настройки

* **ALLOWED\_TOURNAMENT\_IDS** — список кодов турниров, которые включаются в итог (можно оставить пустым для анализа всех).
* **NOCHANGE\_STATUSES** — список "нулевых" статусов (строка попадает в итог только если есть хоть один статус **не** из этого списка).
* **STATUS\_COLORS\_DICT** — словарь цвета для каждого статуса (например, `"NO_RANK": "#EDEDED"`).
* **PRIORITY\_COLS, COMPARE\_FIELDS, COMPARE\_KEYS** — списки колонок для сортировки и сравнения.
* **Логирование** — подробный лог по каждому этапу (число строк, примеры, ошибки).

---

## Структура проекта

```
.
├── Main.py
├── README.md
├── before.json
├── after.json
├── compare_result.xlsx
├── requirements.txt
└── (остальные ваши файлы/логи)
```

---

## Требования

* Python 3.8+
* pandas
* xlsxwriter

Установка зависимостей:

```bash
pip install pandas xlsxwriter
```

---

## Пример статусов

| Статус               | Значение / Пояснение                      |
| -------------------- | ----------------------------------------- |
| No Change            | Не изменился                              |
| NEW / ADD            | Появился в новой версии                   |
| REMOVE / REMOVE FROM | Был, но исчез                             |
| UP / DOWN            | Значение выросло/упало                    |
| NO\_RANK             | Рейтинг отсутствует в обеих версиях       |
| PRIZE\_UNCHANGED     | Призовая категория не изменилась          |
| STAYED\_OUT          | Вне призовых                              |
| ...                  | ... (остальные статусы по логике скрипта) |

---

## Цвета статусов (пример)

```python
STATUS_COLORS_DICT = {
    "No Change": "#FFFFFF",
    "NEW": "#B7E1CD",
    "REMOVE": "#F4CCCC",
    "UP": "#A4C2F4",
    "DOWN": "#F9CB9C",
    "NO_RANK": "#EDEDED",      # Светло-серый (отсутствует рейтинг)
    "PRIZE_UNCHANGED": "#D9D9D9",
    "STAYED_OUT": "#EEEEEE",
    # ... остальные статусы ...
}
```

---

# Техническое задание (ТЗ)

---

## 1. **Парсинг и обработка JSON-файлов турниров**

* Входной файл — JSON с ключом `tournamentId` и данными по турниру/лидерам.
* Обработка вложенных структур, поддержка разных типов (`list`, `dict`).
* Числовые поля устойчиво приводятся к нужному типу.
* Если лидеры отсутствуют — добавлять заглушку.

---

## 2. **Сравнение файлов**

* Сравнение по ключу `(tournamentId, employeeNumber)`.
* Для каждого поля сравнения рассчитывать статус (`NEW`, `REMOVE`, `UP`, `DOWN`, `NO_RANK` и др.).
* Для категорий призёра сравнивать переходы, улучшения, ухудшения.
* В итоговый COMPARE попадают только строки с реальными изменениями (см. фильтр выше).
* Добавить отдельную фильтрацию по списку турниров (`ALLOWED_TOURNAMENT_IDS`).

---

## 3. **Логирование и отладка**

* Подробный лог по всем этапам.
* Фиксация количества строк на каждом этапе.
* Примеры значений статусов.
* Отдельный лог ошибок (ошибки не прерывают обработку).

---

## 4. **Результат**

* Excel-файл с тремя листами: "BEFORE", "AFTER", "COMPARE".
* Поддержка цветовой индикации по статусу.
* Готовность файла для анализа в Excel.

---

## 5. **Расширяемость**

* Любой новый статус, цвет, дополнительное поле легко добавить через параметры в начале файла (например, в NOCHANGE\_STATUSES, STATUS\_COLORS\_DICT).
* При необходимости логику сравнения/фильтрации можно доработать централизованно, не меняя основной алгоритм.

---

# Инструкция по запуску

1. **Подготовьте файлы:**
   — исходные `before.json` и `after.json`

2. **Настройте параметры** в начале `Main.py`:
   — список турниров, статусные поля, нужные "нулевые" статусы

3. **Запустите:**

```bash
python Main.py
```

4. **Откройте `compare_result.xlsx`** — все отличия и итоговый свод по статусам изменений.

---

## Примеры кода функций (фрагменты)

```python
def parse_json_file(filepath):
    ...
    # Чтение и преобразование JSON в плоскую таблицу

def make_compare_sheet(df_before, df_after, sheet_name):
    ...
    # Сравнение, проставление статусов, фильтрация, логирование

def is_any_change(row):
    for col in status_cols:
        val = str(row.get(col, "")).strip()
        if val not in NOCHANGE_STATUSES and not (val.startswith("Rang") and "NO CHANGE" in val):
            return True
    return False
# Фильтрация:
mask = compare_df.apply(is_any_change, axis=1)
compare_df = compare_df[mask].reset_index(drop=True)
```