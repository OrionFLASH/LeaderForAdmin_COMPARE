# LFA Tournament Compare — Программа для сравнения JSON-отчетов по турнирам

## Описание

Данная программа предназначена для **автоматического сравнения выгрузок по турнирам** в формате JSON (лидеры по турнирам), построения отчета изменений и формирования итоговой кросс-таблицы по всем сотрудникам в разрезе турниров с цветовой маркировкой статусов.  
Результаты сохраняются в формат Excel (xlsx) с подробной раскраской и легендой статусов.

Программа позволяет анализировать изменения между двумя выгрузками (`BEFORE` и `AFTER`), отслеживать попадания в призовые категории, выбытия, перемещения в рейтинге и другие изменения для каждого сотрудника.

---

## Техническое задание (ТЗ)

- **Вход**: две JSON-выгрузки с результатами по турнирам (`BEFORE` и `AFTER`).
- **Выход**: Excel-файл с тремя основными листами:
    1. Сырые данные BEFORE (до изменений)
    2. Сырые данные AFTER (после изменений)
    3. Лист сравнения (COMPARE) — статус изменений по каждому сотруднику в каждом турнире
    4. Итоговая финальная таблица (FINAL) — разрез по всем турнирам
    5. Лист с легендой статусов

- **Задачи:**
    - Автоматическое извлечение всех полей, включая вложенные (divisionRatings), с сохранением структуры
    - Сопоставление данных между выгрузками по уникальному ключу (employeeNumber + tournamentId + ФИО)
    - Формирование для каждого сотрудника и турнира статусов: повышение/понижение в рейтинге, вход в призеры, выбывание, отсутствие изменений, новое добавление, удаление и др.
    - Цветовая маркировка всех статусных колонок согласно бизнес-правилам
    - Логирование процесса для последующего аудита и отладки

---

## Архитектура и описание модулей

### Основные этапы работы

1. **Конфигурация путей и переменных**
    - В начале файла задаются пути к папкам исходных файлов, итоговых Excel, логов.
    - Определяются имена файлов BEFORE и AFTER, имя файла для вывода результата, список анализируемых турниров (если нужен фильтр).

2. **Парсинг и плоская нормализация JSON**
    - Функция `process_json_file(filepath)` — преобразует каждый JSON-файл в DataFrame, нормализуя структуру и вытаскивая все вложенные поля (divisionRatings_BANK, divisionRatings_TB и т.д.).
    - Все значения типов float и int приводятся к корректному формату.

3. **Построение сравнения (COMPARE)**
    - Функция `make_compare_sheet(df_before, df_after, sheet_name)` — строит DataFrame, где для каждой пары (employeeNumber, tournamentId, ФИО) содержится информация из обеих выгрузок и формируется статус изменений по ключевым полям.
    - Сравниваются: сумма показателя, место в рейтинге, призовые категории, присутствие/отсутствие сотрудника.

4. **Финальная сводная таблица (FINAL)**
    - Функция `build_final_sheet(...)` — для каждого уникального сотрудника строит по каждому турниру итоговый статус: лучший призовой статус, признак присутствия, или “не участвовал”.
    - Логика выбора “лучшего” статуса регулируется через `CATEGORY_RANK_MAP`.

5. **Экспорт и цветовая маркировка**
    - Весь экспорт в Excel реализован через функцию `add_smart_table(...)` с автошириной и жирными заголовками.
    - Цветовая маркировка реализуется через `apply_status_colors(...)`, список всех цветов статусов задаётся в константе `STATUS_COLORS_DICT`.
    - На отдельном листе строится легенда всех статусов и их расшифровка.

6. **Логирование**
    - Вся работа сопровождается подробным логированием в файл и консоль через `setup_logger(...)`.

---

## Переменные, константы и их назначение

| Имя                  | Назначение                                                                              |
|----------------------|-----------------------------------------------------------------------------------------|
| SOURCE_DIR           | Путь к папке с исходными JSON-файлами                                                   |
| TARGET_DIR           | Путь для сохранения итоговых Excel-файлов                                               |
| LOG_DIR              | Путь к папке логов                                                                      |
| LOG_BASENAME         | Базовое имя для лог-файлов                                                              |
| BEFORE_FILENAME      | Имя файла выгрузки "до изменений"                                                       |
| AFTER_FILENAME       | Имя файла выгрузки "после изменений"                                                    |
| RESULT_EXCEL         | Имя итогового Excel-файла                                                               |
| ALLOWED_TOURNAMENT_IDS| Список tournamentId для анализа (если пуст — анализируются все)                        |
| NOCHANGE_STATUSES    | Список статусов, которые считаются “без изменений”                                      |
| PRIORITY_COLS        | Ключевые поля для вывода                                                               |
| COMPARE_KEYS         | Ключи сравнения для склейки данных (employeeNumber, tournamentId, ФИО)                 |
| COMPARE_FIELDS       | Поля для сравнения между BEFORE и AFTER                                                |
| INT_FIELDS           | Поля, которые приводятся к int                                                         |
| FLOAT_FIELDS         | Поля, которые приводятся к float                                                       |
| STATUS_COLORS_DICT   | Словарь “статус → цвет ячейки в Excel”                                                 |
| STATUS_COLOR_COLUMNS | Колонки для окрашивания в отчете                                                       |
| STATUS_RU_DICT       | Справочник статусов: код → (русское описание, комментарий)                             |
| STATUS_NEW_REMOVE, ...| Словари для бизнес-логики сравнения статусов                                           |
| CATEGORY_RANK_MAP    | Маппинг названий призовых категорий на числовой ранг (меньше — лучше)                  |
| STATUS_RATING_CATEGORY| Коды бизнес-статусов для категории                                                    |

---

## Основные функции и их краткое описание

- **setup_logger** — инициализация логгера (файл + консоль)
- **parse_int, parse_float** — преобразование значений к числовым типам с логированием ошибок
- **flatten_leader** — нормализация одной записи “лидер” в плоский словарь для DataFrame
- **process_json_file** — обработка одного JSON-файла, возврат списка строк
- **load_json_folder** — обработка всех JSON-файлов в папке
- **make_compare_sheet** — построение DataFrame для отчета сравнения
- **build_final_sheet** — формирование итоговой кросс-таблицы (финал)
- **add_smart_table** — экспорт DataFrame в Excel с автоформатированием
- **apply_status_colors** — цветовая раскраска ячеек Excel по статусу
- **add_status_legend** — добавление листа-легенды в итоговый Excel
- **main** — основной сценарий, связывает все этапы

---

## Пример запуска

1. Проверьте пути к исходным данным (`SOURCE_DIR`), целевой папке (`TARGET_DIR`) и логам (`LOG_DIR`).
2. Задайте имена файлов BEFORE и AFTER.
3. Запустите скрипт:
   ```bash
   python Main.py
````

4. По завершению работы в целевой папке появится Excel-файл с подробным отчетом.

---

## Примеры использования и модификации

* Для анализа не всех, а только части турниров — укажите их в `ALLOWED_TOURNAMENT_IDS`.
* Для изменения бизнес-логики расчета “лучшего” статуса поменяйте `CATEGORY_RANK_MAP`.
* Для расширения сравнения добавьте нужные поля в `PRIORITY_COLS` и аналогичные списки.

---

## Требования

* Python 3.8+
* pandas
* openpyxl

Установить зависимости:

```bash
pip install pandas openpyxl
```

---