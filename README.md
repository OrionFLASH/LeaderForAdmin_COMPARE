
---

# LFA Tournament Compare — Программа для сравнения JSON-отчетов по турнирам

## Описание

Программа для **автоматизированного сравнения результатов турниров** по выгрузкам в формате JSON. Позволяет строить комплексный отчёт о любых изменениях в позициях, призовых местах, статусах и присутствии сотрудников между двумя выгрузками (`BEFORE` и `AFTER`).
Итоговый файл формируется в формате Excel с цветовой маркировкой статусов и легендой, а также с отдельными листами по различной бизнес-логике (призовые категории, статусы присутствия и пр.).
Поддерживаются сводные итоги по статусам и группам, быстрый анализ трендов.

---

## Техническое задание (ТЗ)

### Входные данные

* **Две JSON-выгрузки:** `BEFORE` и `AFTER`, каждая из которых содержит структуру по турнирам и спискам сотрудников (лидеров).
* Файлы могут содержать сложно вложенные структуры (divisionRatings).

### Выходные данные

* **Excel-файл** (`.xlsx`), содержащий следующие листы:

  1. **BEFORE** — исходные сырые данные до изменений
  2. **AFTER** — данные после изменений
  3. **COMPARE** — таблица с поэлементным сравнением и статусами изменений по ключевым полям
  4. **FINAL** — кросс-таблица по всем сотрудникам и турнирам с призовыми статусами (лучший призовой статус по каждому турниру)
  5. **FINAL\_PLACE** — кросс-таблица по статусам перемещений (места в рейтинге: BANK, TB, GOSB)
  6. **STATUS\_LEGEND** — расшифровка статусов и цвета, а также групп
  7. **FINAL\_RAW**, **FINAL\_PLACE\_RAW** — технические листы с промежуточными данными (при необходимости)

* На каждом листе FINAL и FINAL\_PLACE справа добавляются итоговые колонки:

  * Подсчёт по каждому статусу: сколько раз встретился данный статус по всем турнирам для сотрудника.
  * TOP-1/2/3 — наиболее часто встречающиеся статусы (в порядке убывания частоты, если несколько — через запятую).
  * Для FINAL: по группам (например, "Поднялся в рейтинге и Новый призёр", "Стал призёром" и т.д.), а также вывод группы, в которой больше всего статусов (GRP\_MAX).

### Требования

* Автоматическое извлечение всех полей, включая вложенные (divisionRatings), для корректного анализа.
* Сопоставление сотрудников по комбинации ключей (employeeNumber, tournamentId, ФИО).
* Построение сравнения для всех ключевых бизнес-показателей (призовые категории, места, статусы).
* Цветовая маркировка и детальная легенда для всех статусов и групп.
* Подробное логирование всех этапов работы.
* Гибкая архитектура для расширения логики сравнения и агрегации.
* Все листы Excel с автофильтрами и закреплением заголовка и ключевых колонок (по шаблону).

---

## Логика работы и архитектура

### Основные этапы

1. **Настройка переменных и путей**
   Все параметры (пути, имена файлов, списки турниров и статусов) вынесены в начало скрипта для максимальной гибкости.

2. **Загрузка и нормализация данных**

   * Функция `process_json_file()` превращает каждый файл в DataFrame с плоской структурой, "разворачивая" вложенные блоки.
   * Все числовые и строковые значения корректно приводятся к стандартному типу.

3. **Сравнение выгрузок**

   * `make_compare_sheet()` строит таблицу различий по каждому сотруднику и турниру, а также статусные колонки для BANK, TB, GOSB.
   * Вся бизнес-логика вынесена в отдельные функции.

4. **Построение финальных сводных таблиц**

   * `build_final_sheet_fast()` — кросс-таблица по лучшим призовым статусам (для каждого турнира у сотрудника).
   * `build_final_place_sheet_from_compare()` — кросс-таблица по статусам перемещений (BANK/TB/GOSB).
   * Итоговые листы обогащаются колонками-итогами по статусам (см. далее).

5. **Агрегация итогов**

   * `add_status_summary_columns()` — добавляет справа колонки по каждому статусу (количество), а также TOP-1/2/3 (самые частые статусы).
   * `add_status_count_and_top3()` — дополнительная агрегация: группы статусов, определение лидирующей группы (GRP\_MAX) с расшифровкой.

6. **Экспорт и оформление**

   * Все DataFrame выгружаются в Excel с автоформатированием, автофильтрами и закреплением заголовка и ключевых столбцов (см. функцию `add_smart_table()`).
   * Цветовая разметка реализована через `apply_status_colors()`, покрывает все статусные и итоговые колонки.
   * Для легенды статусов и групп создается отдельный лист `add_status_legend()`.

7. **Логирование**

   * Используется `setup_logger()`. Все этапы и их результат фиксируются с детализацией (размеры, распределение статусов, время выполнения, структура данных).

---

## Описание функций

### Основные и экспортируемые функции

* **setup\_logger(log\_dir, basename)**
  Настраивает логгер: ведёт лог в файл и в консоль.
* **log\_data\_stats(df, label)**
  Статистика по DataFrame (размер, список турниров, поля).
* **log\_compare\_stats(compare\_df)**
  Сводная статистика по статусам на листе COMPARE.
* **parse\_int(val, context=None)**
  Безопасное преобразование значения к int (с логированием ошибок).
* **parse\_float(val, context=None)**
  Безопасное преобразование значения к float (с логированием ошибок).
* **flatten\_leader(leader, tournament\_id, source\_file)**
  Преобразует одну запись "лидер" в плоский словарь для DataFrame.
* **process\_json\_file(filepath)**
  Чтение одного JSON-файла и формирование списка строк для DataFrame.
* **make\_compare\_sheet(df\_before, df\_after, sheet\_name)**
  Сравнение всех ключевых полей по сотрудникам и турнирам, формирование статусных колонок.
* **build\_final\_sheet\_fast(compare\_df, allowed\_ids, ..., df\_before, df\_after, log)**
  Формирование кросс-таблицы по лучшим призовым статусам для каждого сотрудника/турнира.
* **build\_final\_place\_sheet\_from\_compare(compare\_df, allowed\_ids, df\_before, df\_after, log, sheet\_name)**
  Формирование кросс-таблицы по статусам перемещений (BANK, TB, GOSB).
* **add\_status\_summary\_columns(df, tournaments, status\_list, log, sheet\_name, suffix="")**
  Добавляет колонки по каждому статусу (количество встреч в строке).
* **add\_status\_count\_and\_top3(df, status\_cols, all\_statuses, log, is\_final\_place=False)**
  Итоги по статусам, TOP-3, а также по группам (для FINAL).
* **add\_smart\_table(writer, df, sheet\_name, table\_name, freeze\_map=None)**
  Экспорт DataFrame на лист Excel: автоширина, жирные заголовки, автофильтр, закрепление заголовка и ключевых колонок (по freeze\_map).
* **apply\_status\_colors(writer, df, sheet\_name, status\_color\_map, status\_columns)**
  Цветовая раскраска ячеек в Excel по статусу.
* **add\_status\_legend(writer, legend\_data, sheet\_name)**
  Добавляет лист-легенду по статусам и цветам (а также группам).
* **main()**
  Основной сценарий (полный пайплайн, вся логика, логирование).

### Внутренние (служебные) функции

* **category\_compare\_enhanced(row, colname)**
  Сравнение призовых категорий BANK/TB/GOSB для одной строки.
* **value\_compare(row)**
  Сравнение показателя indicatorValue для одной строки.
* **rang\_compare(row, before\_col, after\_col, status\_dict)**
  Сравнение места (placeInRating) с учётом направления (вверх/вниз/без изменений).
* **load\_json\_folder(folder)**
  Для пакетной обработки папки с выгрузками (по требованию).

---

## Группы статусов

В программе статусы объединены в бизнес-группы, которые выводятся в итоговых колонках и легенде:

| Группа | Название                                     | Описание/статусы                           |
| ------ | -------------------------------------------- | ------------------------------------------ |
| 1      | "Поднялся в рейтинге и Новый призёр"         | Новый призёр, Поднялся в рейтинге призеров |
| 2      | "Стал призёром"                              | Стал призёром                              |
| 3      | "Сохранил призовую позицию"                  | Сохранил призовую позицию                  |
| 4      | "Снизил призовое место"                      | Снизил призовое место                      |
| 5      | "Лишился награды и Удалённый призёр"         | Лишился награды, Удалённый призёр          |
| 6      | "Без изменений и Новый участник без награды" | Без изменений, Новый участник без награды  |
| 7      | "Удалённый участник без награды"             | Удалённый участник без награды             |
| 8      | "Не участвовал"                              | Не участвовал                              |

Группа с наибольшим количеством у сотрудника выделяется в колонке GRP\_MAX (выводится **название**, а не просто "Группа N").

---

## Особенности и нюансы реализации

* **Автофильтры и закрепление**:
  Все листы Excel автоматически получают автофильтр по первой строке и закрепление ключевых столбцов (`freeze_map` задается централизованно).
* **Цветовая разметка универсальна** — достаточно добавить статус в STATUS\_COLORS\_DICT и он сразу начнет окрашиваться на всех листах.
* **Полный аудит**:
  Логируются не только размеры, но и распределения статусов, итоги по группам, промежуточные результаты, время каждого этапа.
* **Безопасность и устойчивость**:
  Все функции проверяют и обрабатывают пустые значения, пропуски, ошибки типов; любые исключения логируются.
* **Легко масштабировать**:
  Архитектура поддерживает добавление новых типов сравнений, новых групп, других сводных итогов — весь код максимально декомпозирован.
* **Работает с любыми выгрузками с подобной структурой**.

---

## История изменений (changelog / highlights)

* **v0.1** — Первый прототип, базовое парсирование JSON и сравнение по ключам.
* **v0.2** — Добавлено сравнение призовых мест, статусов, выделение "Новых" и "Удалённых".
* **v0.3** — Построение итоговой кросс-таблицы (FINAL), поддержка цветовой разметки.
* **v0.4** — Введён лист FINAL\_PLACE, раздельный подсчёт статусов перемещений (BANK/TB/GOSB).
* **v0.5** — Итоговые колонки (summary): подсчёт количества каждого статуса для сотрудника.
* **v0.6** — Введён TOP-3 по статусам для каждого сотрудника, обработка множественных значений.
* **v0.7** — Группировка статусов по бизнес-группам, вывод GRP\_MAX с текстовым описанием.
* **v0.8** — Унификация цветовой схемы, поддержка всех новых статусов и групп в легенде.
* **v0.9** — Автоматизация оформления Excel: автофильтры, закрепление колонок, выбор активного листа.
* **v1.0** — Полное покрытие логами (разбивка по этапам, логирование размеров, промежуточных результатов, времени выполнения).
* **v1.1** — Мелкие оптимизации: пакетная обработка, обработка ошибок, повышение скорости сводных функций.
* **v1.2** — Функция расширенной агрегации по статусам и группам (add\_status\_count\_and\_top3), итоговые RAW-листы, удобство для тестирования/отладки.
* **v1.3** — Централизованное управление закреплением, универсальные автофильтры, экспорт всех листов с общими параметрами.
* **v1.4** — Добавлена поддержка новых бизнес-групп, обновлённые справочники, расширение README и примеры.

---

## Пример запуска

```bash
python Main.py
```

* Все параметры путей и файлов настраиваются в начале скрипта.
* После завершения работы будет создан Excel-файл с детальным отчетом по всем сотрудникам и турнирам.

---

## Требования

* Python 3.8+
* pandas
* openpyxl

```bash
pip install pandas openpyxl
```

---

## Поддержка/доработка

По вопросам доработки, внедрения новых бизнес-правил или интеграции с другими источниками данных — обращайтесь к автору проекта.

---
