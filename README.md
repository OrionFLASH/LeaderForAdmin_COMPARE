---

# LFA Tournament Compare — Программа для сравнения JSON-отчетов по турнирам

## Описание

Программа для **автоматизированного сравнения результатов турниров** по выгрузкам в формате JSON. Позволяет строить комплексный отчет о любых изменениях в позициях, призовых местах, статусах и присутствии сотрудников между двумя выгрузками (`BEFORE` и `AFTER`).
Итоговый файл формируется в формате Excel с цветовой маркировкой статусов и легендой, а также с отдельными листами по различной бизнес-логике (призовые категории, статусы присутствия и пр.).

---

## Техническое задание (ТЗ)

### Входные данные:

* **Две JSON-выгрузки**: `BEFORE` и `AFTER`, каждая из которых содержит структуру по турнирам и спискам сотрудников (лидеров).

### Выходные данные:

* **Excel-файл** (расширение `.xlsx`), содержащий следующие листы:

  1. **BEFORE** — исходные сырые данные до изменений
  2. **AFTER** — данные после изменений
  3. **COMPARE** — таблица с поэлементным сравнением и статусами изменений
  4. **FINAL** — кросс-таблица по всем сотрудникам и турнирам с призовыми статусами
  5. **FINAL\_PLACE** — кросс-таблица по статусам перемещений (места в рейтинге)
  6. **STATUS\_LEGEND** — расшифровка статусов и цвета
* На каждом листе FINAL/FINAL\_PLACE добавляются итоговые колонки, где **по каждому сотруднику** подсчитывается количество всех возможных статусов (например, сколько раз был "Золото", сколько раз "Без изменений" и т.д.)

### Требования:

* Автоматическое извлечение всех полей, включая вложенные (divisionRatings), для корректного анализа.
* Сопоставление сотрудников по комбинации ключей (employeeNumber, tournamentId, ФИО).
* Построение сравнения для всех ключевых бизнес-показателей (призовые категории, места, статусы).
* Цветовая маркировка и детальная легенда для всех статусов.
* Подробное логирование всех этапов работы.
* Гибкая архитектура для расширения логики сравнения и агрегации.

---

## Логика работы и архитектура

### Основные этапы

1. **Настройка переменных и путей**

   * Все пути и параметры вынесены в начало скрипта (см. раздел "Переменные").
2. **Загрузка и нормализация данных**

   * С помощью `process_json_file()` каждый файл превращается в DataFrame с плоской структурой.
3. **Сравнение выгрузок**

   * Функция `make_compare_sheet()` строит таблицу различий и статусов по каждому сотруднику и турниру.
4. **Финальные сводные таблицы**

   * `build_final_sheet_fast()` — кросс-таблица по призовым категориям (лучший статус по BANK, TB, GOSB).
   * `build_final_place_sheet_from_compare()` — отдельная кросс-таблица по статусам перемещений в рейтинге (BANK, TB, GOSB).
   * На каждом из этих листов вызывается `add_status_summary_columns()`, которая добавляет по сотруднику итоговые колонки — сколько раз встречается каждый возможный статус.
5. **Экспорт и оформление**

   * Все DataFrame выгружаются в Excel с автоформатированием и цветовой разметкой.
   * Цветовая разметка реализована в функции `apply_status_colors()`.
   * Для легенды создается отдельный лист через `add_status_legend()`.
6. **Логирование**

   * Используется `setup_logger()` — весь процесс фиксируется с детализацией (количество, распределение статусов, время выполнения).

---

## Описание функций

### Внешние и основные функции

* **setup\_logger(log\_dir, basename)**
  Настраивает логгер: ведёт лог в файл и в консоль.
* **log\_data\_stats(df, label)**
  Статистика по датафрейму (размер, список турниров, поля).
* **log\_compare\_stats(compare\_df)**
  Сводная статистика по статусам на листе COMPARE.
* **parse\_int(val, context=None)**
  Безопасное преобразование значения к int.
* **parse\_float(val, context=None)**
  Безопасное преобразование значения к float.
* **flatten\_leader(leader, tournament\_id, source\_file)**
  Преобразует одну запись "лидер" в плоский словарь для DataFrame.
* **process\_json\_file(filepath)**
  Чтение одного JSON-файла и формирование списка строк для DataFrame.
* **make\_compare\_sheet(df\_before, df\_after, sheet\_name)**
  Построение датафрейма со сравнением всех ключевых полей по сотрудникам и турнирам.
* **build\_final\_sheet\_fast(compare\_df, allowed\_ids, ..., df\_before, df\_after, log)**
  Формирование кросс-таблицы по лучшим призовым статусам для каждого сотрудника/турнира.
* **build\_final\_place\_sheet\_from\_compare(compare\_df, allowed\_ids, df\_before, df\_after, log, sheet\_name)**
  Построение кросс-таблицы по статусам перемещений (места BANK, TB, GOSB).
* **add\_status\_summary\_columns(df, tournaments, status\_list, log, sheet\_name, suffix="")**
  Добавляет на итоговые листы колонки-итоги: по каждому статусу — сколько раз встретился в строке сотрудника.
* **add\_smart\_table(writer, df, sheet\_name, table\_name)**
  Экспорт DataFrame в Excel с автошириной и жирными заголовками.
* **apply\_status\_colors(writer, df, sheet\_name, status\_color\_map, status\_columns)**
  Раскраска ячеек в Excel по статусу.
* **add\_status\_legend(writer, legend\_data, sheet\_name)**
  Добавляет лист-легенду по статусам и цветам.
* **main()**
  Основной сценарий — объединяет весь пайплайн.

### Внутренние (служебные) функции

* **category\_compare\_enhanced(row, colname)**
  Сравнивает призовые категории для одной строки (BANK/TB/GOSB) с учётом бизнес-логики.
* **value\_compare(row)**
  Сравнение показателя indicatorValue для одной строки.
* **rang\_compare(row, before\_col, after\_col, status\_dict)**
  Сравнение места (placeInRating) с учётом направления (вверх/вниз/без изменений).

---

## Переменные и константы

Подробная таблица ключевых переменных приведена в вашей версии выше.
В дополнение:

* **ALL\_STATUSES\_FINAL** — список всех статусов, возможных на листе FINAL (например, "Вы в лидерах", "Серебро", "Бронза", "Без изменений", "Удалённый призёр" и т.д.)
* **ALL\_STATUSES\_PLACE** — список всех статусов, возможных на листе FINAL\_PLACE (например, "Rang BANK UP", "Rang TB DOWN", "Remove FROM", "CONT", "Not\_used" и др.)

---

## Особенности и нюансы реализации

* **Строгое сопоставление по сотруднику и турниру**: все сравнения строятся только по точному совпадению ключей.
* **Любой сотрудник, который появился или исчез между выгрузками, будет отмечен соответствующим статусом ("Новый", "Удалённый" и т.д.).**
* **Цветовая разметка реализована универсально: при расширении статусов достаточно добавить их в справочник STATUS\_COLORS\_DICT.**
* **Итоговые колонки по статусам строятся для **всех** возможных статусов — если по сотруднику не было такого статуса, будет "0".**
* **Весь процесс разбит на независимые функции для упрощения тестирования и сопровождения.**
* **Программа легко расширяется на новые типы сравнений — достаточно добавить новые функции анализа или изменить списки полей.**

---

## История изменений (changelog/highlights)

* **v0.1** — Первая версия, парсинг JSON и формирование сравнения по ключам.
* **v0.2** — Реализация сравнения не только по факту присутствия, но и по призовым категориям/местам/статусам.
* **v0.3** — Добавлена кросс-таблица FINAL (по лучшему статусу), реализация цветовой маркировки и экспорта в Excel.
* **v0.4** — Реализована отдельная таблица FINAL\_PLACE (по статусу перемещений), раздельные статусы.
* **v0.5** — Добавлены итоговые колонки (summary) по всем статусам для каждого сотрудника.
* **v0.6** — Улучшено логирование: логируются все основные события, а также распределения статусов по турнирам и по строкам.
* **v0.7** — Добавлены вспомогательные справочники, расширены сценарии сравнения, унифицированы функции экспорта.

---

## Пример запуска

```bash
python Main.py
```

* Все параметры путей и файлов настраиваются в начале скрипта.
* После завершения работы будет создан Excel-файл с детальным отчетом по всем сотрудникам и турнирам.

---

## Требования

* Python 3.8+
* pandas
* openpyxl

```bash
pip install pandas openpyxl
```

---

## Поддержка/доработка

По вопросам доработки или внедрения новых бизнес-правил — обращайтесь к автору проекта.

---