---

# LFA Tournament Compare — Программа для сравнения JSON-отчетов по турнирам

## Описание

**LFA Tournament Compare** — профессиональный инструмент для автоматизированного сравнения результатов турниров по выгрузкам в формате JSON.
Позволяет формировать подробный Excel-отчет о любых изменениях в позициях, призовых местах, статусах и присутствии сотрудников между двумя выгрузками (`BEFORE` и `AFTER`).
Программа полностью автоматизирует разбор сложных вложенных структур, построение сводных таблиц, маркировку изменений, агрегацию итогов по статусам и группам.

---

## Техническое задание (ТЗ)

### Входные данные

* **Две JSON-выгрузки:** `BEFORE` и `AFTER`, каждая содержит иерархическую структуру по турнирам и спискам сотрудников (лидеров).
* Возможна любая вложенность, включая массивы в блоке `divisionRatings`.

### Выходные данные

* **Excel-файл** (`.xlsx`) с листами:

  1. **BEFORE** — исходные сырые данные (до изменений)
  2. **AFTER** — новые данные (после изменений)
  3. **COMPARE** — поэлементное сравнение и статусные колонки (BANK, TB, GOSB, категории)
  4. **FINAL** — кросс-таблица по призовым статусам (лучший статус для каждого сотрудника в каждом турнире)
  5. **FINAL\_PLACE** — кросс-таблица по статусам перемещений (BANK/TB/GOSB)
  6. **STATUS\_LEGEND** — расшифровка всех статусов и цветов, бизнес-группы
  7. **FINAL\_RAW**, **FINAL\_PLACE\_RAW** — технические листы (промежуточные данные, можно не экспортировать в финальной версии)
* На **FINAL** и **FINAL\_PLACE** справа добавляются:

  * Итоговые колонки по всем статусам (суммарно по строке)
  * TOP-1/2/3 — наиболее часто встречающиеся статусы для сотрудника (сортировка по убыванию)
  * Для FINAL: бизнес-группы и определение ведущей группы (GRP\_MAX) с расшифровкой

---

### Требования и особенности

* Автоматическое извлечение всех вложенных полей (divisionRatings) для анализа.
* Корректное сопоставление сотрудников по employeeNumber, ФИО, tournamentId.
* Сравнение по всем ключевым бизнес-показателям (категории, места, статусы).
* Универсальная цветовая маркировка и подробная легенда.
* Подробное логирование всех этапов и ошибок.
* Гибкая архитектура, пригодная для расширения (новые группы, статусы, листы).
* Все листы Excel с автофильтром и закреплением ключевых колонок (freeze\_panes).

---

## Архитектура и логика работы

### Основные этапы пайплайна

1. **Настройка параметров**
   Пути, имена файлов, справочники статусов и бизнес-групп — в начале скрипта для быстрой адаптации.
2. **Загрузка и нормализация данных**

   * `process_json_file()` формирует плоский DataFrame из любого JSON (разворачивает все вложения, приводит типы).
3. **Сравнение выгрузок**

   * `make_compare_sheet()` создает таблицу различий и статусные колонки для всех ключевых полей (категории, места, BANK/TB/GOSB).
4. **Построение финальных кросс-таблиц**

   * `build_final_sheet_fast()` — лучшая призовая категория для каждого сотрудника/турнира (FINAL).
   * `build_final_place_sheet_from_compare()` — статусы перемещений по местам (FINAL\_PLACE).
5. **Агрегация итогов**

   * `add_status_summary_columns()` — подсчет количества всех статусов по строке, TOP-1/2/3.
   * `add_status_count_and_top3()` — дополнительная агрегация по бизнес-группам, определение GRP\_MAX.
6. **Экспорт и оформление**

   * Экспорт всех листов Excel с автоформатированием, автофильтром, закреплением областей, цветовой разметкой, выводом легенды.
7. **Логирование**

   * Каждый этап и все важные параметры фиксируются с детализацией (размеры данных, распределения статусов, время, структура).

---

## Полное описание функций

### Основные (экспортируемые, ключевые в пайплайне)

* **setup\_logger(log\_dir, basename)**
  Настройка логгера (файл и консоль, append, полный формат даты и времени).

* **log\_data\_stats(df, label)**
  Статистика по DataFrame (размер, уникальные турниры, поля).

* **log\_compare\_stats(compare\_df)**
  Сводная статистика по статусам для листа COMPARE.

* **parse\_int(val, context=None)**
  Преобразование к int с обработкой ошибок и подробным логом (возвращает None при ошибке).

* **parse\_float(val, context=None)**
  Преобразование к float с учетом разных форматов (строки, запятые/точки, пробелы), логирование ошибок.

* **flatten\_leader(leader, tournament\_id, source\_file)**
  Преобразование вложенного лидера в плоский словарь с нужными префиксами (BANK, TB, GOSB, ...).

* **process\_json\_file(filepath)**
  Чтение JSON, разбор вложенных структур по турнирам, обработка исключений, возврат списка словарей для DataFrame.

* **make\_compare\_sheet(df\_before, df\_after, sheet\_name)**
  Поэлементное сравнение двух выгрузок, формирование всех статусных колонок и итоговой таблицы различий.

* **build\_final\_sheet\_fast(compare\_df, allowed\_ids, out\_prefix, category\_rank\_map, df\_before, df\_after, log, sheet\_name="FINAL")**
  Построение кросс-таблицы по призовым статусам. Оптимизировано для быстрого доступа по ключам.

* **build\_final\_place\_sheet\_from\_compare(compare\_df, allowed\_ids, df\_before, df\_after, log, sheet\_name="FINAL\_PLACE")**
  Кросс-таблица по статусам перемещений (BANK/TB/GOSB).

* **add\_status\_summary\_columns(df, tournaments, status\_list, log, sheet\_name, prefix="")**
  Добавляет справа в DataFrame колонки-сумматоры по каждому статусу (и их сумму по строке).

* **add\_status\_count\_and\_top3(df, status\_cols, all\_statuses, log, is\_final\_place=False)**
  Агрегирует top-1/2/3 статуса и (для FINAL) — распределяет по бизнес-группам, определяет GRP\_MAX (ведущая группа по строке).

* **add\_smart\_table(writer, df, sheet\_name, table\_name, freeze\_map=None)**
  Экспорт DataFrame в Excel с автошириной, жирными заголовками, автофильтром, закреплением ключевых колонок.

* **apply\_status\_colors(writer, df, sheet\_name, status\_color\_map, status\_columns)**
  Цветовая маркировка ячеек в Excel по статусу (фон+шрифт), универсально для всех листов.

* **add\_status\_legend(writer, legend\_data, sheet\_name)**
  Лист-легенда по статусам и цветам, а также по группам (универсальный для любой схемы).

* **apply\_stat\_grp\_conditional\_formatting(writer, sheet\_name, stat\_prefixes=('stat\_', 'grp\_'), log=None)**
  Универсальное условное форматирование по числовым итогам (например, для колонок подсчёта групп и статусов).

* **export\_and\_log(writer, df, sheet\_name, log, freeze\_map=None)**
  Экспорт любого DataFrame на лист, логирование события экспорта.

* **main()**
  Основной сценарий работы: весь пайплайн, логирование, обработка ошибок.

---

### Служебные (внутренние, для построения бизнес-логики)

* **category\_compare\_enhanced(row, colname)**
  Логика сравнения призовых категорий (BANK/TB/GOSB) по таблице переходов (с учетом новых/удалённых/смен статуса).

* **value\_compare(row)**
  Алгоритм сравнения числового показателя (indicatorValue), определяет тип изменения (увеличение/уменьшение/нет изменений/новое/удалено).

* **rang\_compare(row, before\_col, after\_col, status\_dict)**
  Сравнение места в рейтинге с направлением (вверх/вниз/без изменений).

* **get\_status\_distribution(df, status\_list, colnames)**
  Агрегация: считает сколько раз встретился каждый статус по нужным колонкам.

* **get\_group\_distribution(df, group\_cols)**
  Агрегация итогов по бизнес-группам.

---

### (Опционально) Для пакетной обработки

* **load\_json\_folder(folder)**
  Пакетная загрузка всех JSON из папки (используется для массового анализа).

---

## Структура статусов и бизнес-групп

Статусы (и их бизнес-группы) приведены в отдельном справочнике, автоматически отображаются в Excel-легенде.
Каждый статус имеет цветовую маркировку, краткое и полное описание, входит в одну из бизнес-групп.

| Группа | Название                                   | Статусы                                    |
| ------ | ------------------------------------------ | ------------------------------------------ |
| 1      | Поднялся в рейтинге и Новый призёр         | Новый призёр, Поднялся в рейтинге призеров |
| 2      | Стал призёром                              | Стал призёром                              |
| 3      | Сохранил призовую позицию                  | Сохранил призовую позицию                  |
| 4      | Снизил призовое место                      | Снизил призовое место                      |
| 5      | Лишился награды и Удалённый призёр         | Лишился награды, Удалённый призёр          |
| 6      | Без изменений и Новый участник без награды | Без изменений, Новый участник без награды  |
| 7      | Удалённый участник без награды             | Удалённый участник без награды             |
| 8      | Не участвовал                              | Не участвовал                              |

**GRP\_MAX** всегда показывает текстовое название группы для сотрудника.

---

## Особенности реализации

* Все листы Excel получают автофильтр, автоформатирование, freeze\_panes.
* Цветовая маркировка поддерживает добавление любых новых статусов (STATUS\_COLORS\_DICT).
* Любое исключение/ошибка детализировано логируется с привязкой к этапу и данным.
* Код полностью декомпозирован: добавление новых статусов, логик, листов и групп не требует переписывания базовых функций.
* Совместим со всеми версиями Python >= 3.8.

---

## История изменений (changelog, включая мелкие и скрытые)

* **v0.1** — Первый прототип: базовое сравнение по ключам, экспорт в Excel.
* **v0.2** — Сравнение по категориям, местам, цветовая маркировка.
* **v0.3** — Кросс-таблица FINAL, поддержка банковских статусов.
* **v0.4** — Лист FINAL\_PLACE, раздельный подсчёт перемещений.
* **v0.5** — Итоговые колонки по статусам, summary для сотрудников.
* **v0.6** — TOP-3 статуса по частоте, корректная обработка множественных значений.
* **v0.7** — Группы статусов (бизнес-группы), вывод GRP\_MAX.
* **v0.8** — Унификация цветовой схемы, автоматическое обновление легенды, поддержка всех новых статусов.
* **v0.9** — Автоформатирование, закрепление ключевых колонок, выбор активного листа.
* **v1.0** — Полное покрытие логами (разбивка по этапам, время, размеры, промежуточные данные).
* **v1.1** — Мелкие исправления: пакетная обработка, устойчивость к ошибкам формата, ускорение сводных функций.
* **v1.2** — Расширенная агрегация по статусам/группам, итоговые RAW-листы, тестовые методы для отладки.
* **v1.3** — Централизованное управление freeze\_panes, универсальные автофильтры, экспорт всех листов.
* **v1.4** — Новые бизнес-группы, обновлённые справочники, расширенный README, примеры.
* **v1.5** — (мелко) Добавлена подробная отладка при парсинге float/int, защита от пропусков, автоматическое логирование при создании легенды.
* **v1.6** — (мелко) Улучшено условное форматирование итоговых колонок: цвет для 0 — светло-серый шрифт без заливки, для >0 — цветовая шкала.
* **v1.7** — (мелко) Вынесены все параметры форматирования и справочники в начало скрипта, централизованная настройка.
* **v1.8** — (мелко) Обновление структуры экспортируемых данных, дополнительные тесты для проверки целостности данных.

---

## Пример запуска

```bash
python Main.py
```

* Все параметры (пути, имена файлов, список турнирных ID) настраиваются в начале скрипта.
* После завершения работы создается Excel-отчет с подробной структурой.

---

## Требования

* Python 3.8+
* pandas
* openpyxl

```bash
pip install pandas openpyxl
```

---

## Контакты и доработки

По вопросам доработки, внедрения новых бизнес-правил или интеграции с другими источниками данных — обращайтесь к автору проекта.

---