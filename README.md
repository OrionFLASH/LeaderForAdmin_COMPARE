---

# LFA Tournament Compare — Программа для сравнения JSON-отчетов по турнирам

## Описание

**LFA Tournament Compare** — профессиональный инструмент для автоматизированного сравнения результатов турниров по JSON-выгрузкам.
Позволяет формировать подробный Excel-отчет о любых изменениях в позициях, призовых местах, статусах и участии сотрудников между двумя выгрузками (`BEFORE` и `AFTER`).
Реализует полный цикл анализа: разбор вложенных структур, сравнение, построение сводных таблиц, агрегирование итогов, универсальную цветовую разметку, подробную бизнес-легенду и экспорт в Excel.

---

## Техническое задание (ТЗ)

### Входные данные

* **Две JSON-выгрузки:** `BEFORE` и `AFTER`, каждая содержит иерархическую структуру турниров и списков сотрудников (лидеров).
* Возможна любая вложенность, включая массивы в блоке `divisionRatings` (BANK, TB, GOSB и т.д.).
* Справочники для расшифровки названий турниров и конкурсов (`CSV`-файлы).

### Выходные данные

* **Excel-файл (`.xlsx`)** с листами:

  1. **BEFORE** — исходные данные до изменений
  2. **AFTER** — новые данные после изменений
  3. **COMPARE** — сравнение всех ключевых полей, статусные колонки по уровням и объединенные статусы по приоритету BANK→TB→GOSB, подробные описания статусов наград и итоговые строки с описанием изменений
  4. **FINAL** — сводная кросс-таблица по призовым статусам (лучший статус сотрудника в каждом турнире)
  5. **FINAL\_PLACE** — сводная таблица по статусам перемещений (BANK/TB/GOSB)
  6. **STATUS\_LEGEND** — полная расшифровка статусов и цветов, принадлежность к бизнес-группам

* На листах FINAL и FINAL\_PLACE справа добавляются:

  * Итоговые колонки по всем статусам (count per row)
  * TOP-1/2/3 — самые частые статусы сотрудника
  * Для FINAL: принадлежность к бизнес-группам (GRP\_MAX)

---

## Архитектура и логика работы

### Основные этапы

1. **Настройка параметров:**
   Пути, имена файлов, справочники и группы задаются централизованно в начале скрипта.

2. **Загрузка и нормализация данных:**

   * `process_json_file()` формирует плоский DataFrame из любой структуры JSON, разворачивает вложения, приводит типы.
   * Все данные автоматически нормализуются и очищаются от лишних полей (`photoData` и др).

3. **Сравнение выгрузок:**

   * `make_compare_sheet()` строит таблицу различий, заполняет статусные колонки по каждому уровню (BANK, TB, GOSB).
   * `select_best_status_and_level()` выбирает лучший доступный статус по приоритету BANK → TB → GOSB.
   * Формируются объединенные колонки с единым статусом и указанием источника уровня.

4. **Построение финальных таблиц:**

   * `build_final_sheet_fast()` — использует объединенные статусы категорий для определения лучшего призового статуса сотрудника.
   * `build_final_place_sheet_from_compare()` — использует объединенные статусы мест для анализа перемещений.

5. **Агрегация итогов:**

   * `add_status_count_and_top3()` — подсчет всех статусных итогов, TOP-1/2/3, агрегация по бизнес-группам и вычисление GRP\_MAX.

6. **Экспорт и оформление:**

   * Все листы получают автоформатирование, автофильтр, закрепление ключевых колонок, цветовую разметку, подробную легенду.

7. **Логирование:**

   * Подробные сообщения по каждому этапу, все ключевые параметры, размеры, структуру, распределения статусов и время обработки.

---

## Полное описание функций (с параметрами)

### Основные (экспортируемые, ключевые)

#### `setup_logger(log_dir, basename)`

* **Параметры:**

  * `log_dir`: путь к папке для логов
  * `basename`: базовое имя лог-файла
* **Назначение:**
  Запускает логгер, пишет и в файл, и в консоль. Логирование подробное, с отметками времени.

#### `log_data_stats(df, label)`

* **Параметры:**

  * `df`: pandas DataFrame
  * `label`: метка для лога
* **Назначение:**
  Логирует размер, список уникальных турниров и все поля DataFrame.

#### `log_compare_stats(compare_df)`

* **Параметры:**

  * `compare_df`: DataFrame сравнения
* **Назначение:**
  Логирует распределение по всем статусным колонкам COMPARE.

#### `parse_int(val, context=None)`

* **Параметры:**

  * `val`: значение для преобразования
  * `context`: строка-контекст для логирования ошибок
* **Назначение:**
  Корректно переводит значение в int, возвращает None при ошибке, все ошибки логируются.

#### `parse_float(val, context=None)`

* **Параметры:**

  * `val`: значение для преобразования
  * `context`: строка-контекст для логирования ошибок
* **Назначение:**
  Универсальное преобразование в float с поддержкой всех типов разделителей (запятая/точка/пробел).

#### `flatten_leader(leader, tournament_id, source_file)`

* **Параметры:**

  * `leader`: вложенный словарь по сотруднику
  * `tournament_id`: идентификатор турнира
  * `source_file`: имя исходного файла
* **Назначение:**
  Разворачивает все вложения по BANK/TB/GOSB и др., добавляет префиксы, приводит к плоской структуре.

#### `process_json_file(filepath)`

* **Параметры:**

  * `filepath`: путь к JSON-файлу
* **Назначение:**
  Загружает и разбирает файл, корректно обрабатывает вложенные структуры, возвращает список словарей (для DataFrame).

#### `filter_dataframe_by_tournaments(df, allowed_ids, filter_enabled, label="DataFrame")`

* **Параметры:**

  * `df`: DataFrame для фильтрации
  * `allowed_ids`: список разрешенных tournament_ids  
  * `filter_enabled`: флаг включения фильтрации
  * `label`: метка для логирования
* **Назначение:**
  Фильтрует DataFrame по списку турниров в зависимости от параметров. Если фильтрация отключена или список турниров пустой, возвращает исходные данные.

#### `select_best_status_and_level(row, field_type="placeInRating")`

* **Параметры:**

  * `row`: строка DataFrame с данными сравнения
  * `field_type`: тип поля ("placeInRating" или "ratingCategoryName")
* **Назначение:**
  Выбирает лучший доступный статус из трех уровней по приоритету BANK → TB → GOSB. Для placeInRating игнорирует "Нет места", для ratingCategoryName игнорирует пустые значения и служебные статусы. Возвращает кортеж (before_value, after_value, compare_status, level).

#### `get_status_description(status)`

* **Параметры:**

  * `status`: статус для поиска описания
* **Назначение:**
  Получает подробное описание статуса из STATUS_LEGEND_FULL. Возвращает строку с описанием или пустую строку, если статус не найден.

#### `create_summary_row(row, tournament_name)`

* **Параметры:**

  * `row`: строка DataFrame с данными сравнения
  * `tournament_name`: название турнира
* **Назначение:**
  Создает итоговую строку с описанием изменений в формате: "Турнир: {название}. Рейтинг в турнире на прошлой неделе: {BEFORE} Текущий рейтинг: {AFTER} {описание статуса};"

#### `make_compare_sheet(df_before, df_after, sheet_name)`

* **Параметры:**

  * `df_before`, `df_after`: DataFrame до и после
  * `sheet_name`: имя листа
* **Назначение:**
  Поэлементное сравнение, формирование статусных колонок по ключевым показателям.

#### `build_final_sheet_fast(compare_df, allowed_ids, out_prefix, category_rank_map, df_before, df_after, log, sheet_name="FINAL")`

* **Параметры:**

  * `compare_df`: DataFrame сравнения
  * `allowed_ids`: список турнирных id для анализа
  * `out_prefix`: префикс листа
  * `category_rank_map`: карта категорий
  * `df_before`, `df_after`: исходные DataFrame
  * `log`: логгер
  * `sheet_name`: имя листа
* **Назначение:**
  Построение сводной таблицы по призовым статусам (лучший статус для сотрудника/турнира).

#### `build_final_place_sheet_from_compare(compare_df, allowed_ids, df_before, df_after, log, sheet_name="FINAL_PLACE")`

* **Параметры:** аналогично выше
* **Назначение:**
  Сводная таблица по перемещениям в местах (BANK/TB/GOSB).

#### `add_status_count_and_top3(df, status_cols, all_statuses, log, is_final_place=False)`

* **Параметры:**

  * `df`: входной DataFrame
  * `status_cols`: список колонок для анализа
  * `all_statuses`: список всех статусов
  * `log`: логгер
  * `is_final_place`: флаг (для FINAL\_PLACE логика чуть иная)
* **Назначение:**
  Добавляет итоговые колонки (count per status), вычисляет TOP-1/2/3, бизнес-группы и GRP\_MAX.

#### `add_smart_table(writer, df, sheet_name, table_name, freeze_map=None)`

* **Параметры:**

  * `writer`: pd.ExcelWriter
  * `df`: DataFrame
  * `sheet_name`, `table_name`: имена
  * `freeze_map`: словарь freeze panes
* **Назначение:**
  Универсальный экспорт DataFrame с автоформатированием, автофильтром и закреплением.

#### `apply_status_colors(writer, df, sheet_name, status_color_map, status_columns)`

* **Параметры:**

  * `writer`, `df`, `sheet_name`
  * `status_color_map`: словарь цветов
  * `status_columns`: колонки, которые маркируются
* **Назначение:**
  Маркировка ячеек по статусу (фон + цвет текста).

#### `add_status_legend(writer, legend_data, sheet_name)`

* **Параметры:**

  * `writer`, `legend_data`, `sheet_name`
* **Назначение:**
  Выводит полную легенду статусов, цветов и групп.

#### `apply_stat_grp_conditional_formatting(writer, sheet_name, stat_prefixes=('stat_', 'grp_'), log=None)`

* **Параметры:**

  * `writer`, `sheet_name`
  * `stat_prefixes`: префиксы итоговых колонок
  * `log`: логгер
* **Назначение:**
  Условное форматирование итоговых колонок (цветовая шкала для >0, серый текст для 0).

#### `export_and_log(writer, df, sheet_name, log, freeze_map=None)`

* **Параметры:**

  * `writer`, `df`, `sheet_name`, `log`, `freeze_map`
* **Назначение:**
  Экспорт листа и логирование события.

#### `main()`

* **Назначение:**
  Центральная функция, объединяющая весь пайплайн. Все шаги: загрузка, обработка, сравнение, формирование сводных таблиц, агрегация, экспорт, логирование, построение легенды.

---

### Вспомогательные (служебные, внутренние)

* **category\_compare\_enhanced(row, colname)**
  — Логика сравнения призовых категорий, по бизнес-таблице переходов.
* **value\_compare(row)**
  — Сравнение индикатора (рост, падение, появление, пропадание, нет изменений).
* **rang\_compare(row, before\_col, after\_col, status\_dict)**
  — Сравнение места (BANK/TB/GOSB), возврат статус-кода по словарю.
* **get\_status\_distribution(df, status\_list, colnames)**
  — Агрегация по статусам для любой группы колонок.
* **get\_group\_distribution(df, group\_cols)**
  — Агрегация итогов по группам.

---

## Справочник статусов и их получение

**Статусы всегда фиксируются как строка (текст), для каждой комбинации “было — стало” (см. category\_compare\_lookup):**

| Статус                               | Когда возникает (пример бизнес-логики)                                           |
| ------------------------------------ | -------------------------------------------------------------------------------- |
| Новый призёр                         | Не было в выгрузке — стал призёром (любая призовая категория)                    |
| Поднялся в рейтинге призеров         | Был призёром, стал выше в призовой иерархии (бронза → серебро, серебро → золото) |
| Стал призёром                        | Был без награды, стал призёром                                                   |
| Сохранил призовую позицию            | Был и остался на том же призовом уровне                                          |
| Снизил призовое место                | Был призёром, стал ниже (золото → серебро и т.д.)                                |
| Лишился награды                      | Был призёром, стал без награды                                                   |
| Удалённый призёр                     | Был призёром, исчез (удалён)                                                     |
| Остался вне призеров                 | Был и остался без награды                                                        |
| Новый участник без награды           | Появился впервые, но не стал призёром                                            |
| Удалённый участник без награды       | Был без награды, исчез (удалён)                                                  |
| Не участвовал                        | Не было в обеих выгрузках                                                        |
| Улучшил место (BANK/TB/GOSB)         | Место по числу улучшилось (стало меньше)                                         |
| Хуже место (BANK/TB/GOSB)            | Место стало хуже (больше)                                                        |
| Новый с местом (BANK/TB/GOSB)        | Появилось место в новом турнире                                                  |
| Место пропало (BANK/TB/GOSB)         | Было место, стало нет                                                            |
| Такое же место (BANK/TB/GOSB)        | Место не изменилось                                                              |
| Нет места                            | Не было и нет                                                                    |
| Нет призового значения               | Был, но категория не определена                                                  |
| Индикатор вырос/упал/добавлен/пропал | Поразрядное сравнение показателя (indicatorValue)                                |

**Примеры получения (алгоритмы):**

* `category_compare_enhanced()` — определяет, как изменился призовой статус между BEFORE/AFTER.
* `rang_compare()` — определяет перемещения по месту (up/down/такое же/нет/пропало).

---

## История изменений (changelog)

* v0.1 — Первый прототип: сравнение по ключам, экспорт Excel
* v0.2 — Сравнение категорий и мест, цветовая схема
* v0.3 — Кросс-таблица FINAL, поддержка BANK/TB/GOSB
* v0.4 — FINAL\_PLACE, раздельный подсчет перемещений
* v0.5 — Итоговые колонки по статусам, TOP-1/2/3
* v0.6 — Корректная обработка дублей, расширение логики TOP-3
* v0.7 — Группы статусов (бизнес-группы), расчет GRP\_MAX
* v0.8 — Унификация цветовой схемы и легенды
* v0.9 — Автоформатирование, freeze\_panes, выбор активного листа
* v1.0 — Подробное логирование всех этапов
* v1.1 — Повышение надежности, пакетная обработка
* v1.2 — Расширенная агрегация данных
* v1.3 — Централизованное управление freeze\_panes
* v1.4 — Новые бизнес-группы и справочники
* v1.5 — Улучшенное логирование при парсинге чисел, защита от пропусков
* v1.6 — Улучшено условное форматирование итоговых колонок
* v1.7 — Централизованные параметры, оптимизация конфигурирования
* v1.8 — Расширение структуры данных, дополнительные тесты
* v1.9 — Параметр фильтрации турниров в листах BEFORE/AFTER, функция filter_dataframe_by_tournaments
* v2.0 — Объединенные статусы по приоритету BANK→TB→GOSB, функция select_best_status_and_level, новые колонки в COMPARE
* v2.1 — Подробные описания статусов наград и итоговые строки в листе COMPARE, функции get_status_description и create_summary_row

---

## Требования

* Python 3.8+
* pandas
* openpyxl

```bash
pip install pandas openpyxl
```

---

## Настройка параметров

Основные параметры конфигурации задаются в начале файла `Main.py`:

### Фильтрация турниров

* **`ALLOWED_TOURNAMENT_IDS`** — список ID турниров для анализа. Если пустой, анализируются все турниры из исходных файлов.

* **`FILTER_TOURNAMENTS_IN_BEFORE_AFTER`** — управляет фильтрацией данных в листах BEFORE и AFTER:
  - `True` — загружаются только турниры из `ALLOWED_TOURNAMENT_IDS`
  - `False` — загружаются все турниры (по умолчанию)
  - Если `ALLOWED_TOURNAMENT_IDS` пустой, загружаются все турниры независимо от этого параметра

**Примеры использования:**

```python
# Загрузить все турниры в BEFORE/AFTER, но фильтровать только COMPARE/FINAL
ALLOWED_TOURNAMENT_IDS = ["t_01_2025-2_08-2_6_2031", "t_01_2025-2_09-1_1_3071"]
FILTER_TOURNAMENTS_IN_BEFORE_AFTER = False

# Фильтровать все листы включая BEFORE/AFTER
ALLOWED_TOURNAMENT_IDS = ["t_01_2025-2_08-2_6_2031", "t_01_2025-2_09-1_1_3071"] 
FILTER_TOURNAMENTS_IN_BEFORE_AFTER = True

# Загрузить все турниры везде
ALLOWED_TOURNAMENT_IDS = []
FILTER_TOURNAMENTS_IN_BEFORE_AFTER = False
```

### Другие параметры

* **Пути к файлам:** `SOURCE_DIR`, `TARGET_DIR`, `LOG_DIR`
* **Имена файлов:** `BEFORE_FILENAME`, `AFTER_FILENAME`, `RESULT_EXCEL`
* **Логирование:** `LOG_LEVEL` (INFO или DEBUG)

---

## Запуск

```bash
python Main.py
```

---

## Контакты и доработки

По вопросам внедрения новых бизнес-правил или интеграции — обращайтесь к разработчику.

---
