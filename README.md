
# LFA Leader Comparison Script

## Назначение

Скрипт предназначен для **сравнения и анализа изменений в списках лидеров** по двум версиям исходных JSON-файлов, выгруженных из корпоративных систем. Результаты сохраняются в формате Excel с подробной расшифровкой статусов изменений и цветовой индикацией.

---

## Описание процесса

1. **Загрузка данных:**

   * Программа принимает на вход два JSON-файла (до и после изменений), которые содержат данные по турнирам и лидерам (раздел `leaders`).
   * Пути к файлам и директориям указываются в модуле `config.py`.
   * Также задаются имена для Excel- и лог-файлов, список приоритетных колонок, правила сравнения и цвета статусов.

2. **Парсинг и плоское разворачивание:**

   * Каждый JSON-файл преобразуется в таблицу:
     Каждая строка — один участник (лидер) по уникальной связке `tournamentId + employeeNumber`.
   * Все вложенные структуры преобразуются в "плоские" колонки, с префиксами для вложенности.
   * Автоматически исключаются ненужные поля (например, `photoData`).

3. **Единая структура данных:**

   * Для обеих таблиц формируется единый список колонок — все отсутствующие в одном из файлов колонки добавляются как пустые.
   * Значения определённых полей приводятся к числовому формату, где требуется (целые/дробные).

4. **Сравнение (COMPАRE):**

   * Формируется итоговая таблица сравнения всех уникальных комбинаций (`tournamentId + employeeNumber`) из двух файлов.
   * Для каждого участника в таблице отражаются:

     * Статус присутствия (No Change / New / Remove)
     * Изменение ключевых показателей (`indicatorValue`, призовые места, категория рейтинга)
     * Все значения до и после по каждому полю
     * Статусы изменений по каждому из сравниваемых полей согласно бизнес-логике (см. ниже)

5. **Экспорт в Excel:**

   * Генерируются 3 листа:

     * BEFORE — исходные данные
     * AFTER — новые данные
     * COMPARE — итоговое сравнение
     * STATUS\_LEGEND — справочник по статусам сравнения с цветами и пояснениями
   * Для каждой таблицы применяется форматирование “умной таблицы”.
   * Столбцы с результатами сравнений автоматически раскрашиваются по статусу (цвета задаются в config.py). Для тёмного фона — белый текст.

6. **Ведение лога:**

   * Подробный лог по всем этапам сохраняется в файле (по дням, с разбивкой по сессиям), в отдельной директории. В лог выводится:

     * Сколько данных загружено/обработано
     * Какие турниры и лидеры добавились/удалились
     * Итоги сравнений по каждому полю

---

## Описание формата входных данных

* **JSON** с разделом `leaders` внутри блока турнира. Пример структуры:

```json
{
  "body": {
    "tournament": {
      "tournamentId": "TUR_20240101",
      "leaders": [
        {
          "employeeNumber": "123456",
          "lastName": "Иванов",
          "divisionRatings": {
            "BANK": { ... },
            "TB": { ... },
            "GOSB": { ... }
          },
          ...
        },
        ...
      ]
    }
  }
}
```

---

## Описание листов Excel

### 1. BEFORE / AFTER

* Каждая строка — участник турнира (уникальная пара tournamentId + employeeNumber)
* Столбцы — все распарсенные поля из JSON
* Порядок столбцов определяется PRIORITY\_COLS (см. config.py)

### 2. COMPARE

* Каждая строка — уникальная комбинация (tournamentId + employeeNumber)
* Для каждой строки:

  * Статус присутствия: **New**, **Remove**, **No Change**
  * Изменения по основным числовым и категориальным полям
  * Для каждого поля — значения “до” и “после” (с префиксами BEFORE\_/AFTER\_)
  * Статусы сравнения: для `indicatorValue`, `placeInRating`, `ratingCategoryName` — см. раздел "Логика сравнений"

### 3. STATUS\_LEGEND

* Справочник по всем статусам, используемым для раскраски COMPARE-листа
* Включает:

  * Код статуса
  * Перевод на русский
  * Цвет заливки (см. скриншот)
  * Подробный комментарий, что означает статус

---

## Логика сравнения статусов

### 1. Присутствие участника

* **New** — появился только в AFTER
* **Remove** — был только в BEFORE
* **No Change** — есть и в BEFORE, и в AFTER

### 2. Изменения показателя `indicatorValue`

* **New ADD** — значение появилось
* **Remove FROM** — значение исчезло
* **Change UP** — увеличился
* **Change DOWN** — уменьшился
* **No Change** — не изменился

### 3. Изменения рейтинга (placeInRating)

* **Rang ... UP** — ранг стал лучше (меньше = лучше)
* **Rang ... DOWN** — ранг стал хуже (больше)
* **Rang ... NO CHANGE** — не изменился
* **Rang ... NEW/REMOVE** — появилось/исчезло значение

### 4. Изменения категории призёра (`ratingCategoryName`)

* **ENTERED\_PRIZE** — участник стал призёром (попал в топ-3)
* **STAYED\_OUT** — участник остался вне призёров
* **DROPPED\_OUT\_PRIZE** — участник был призёром, но выбыл
* **LOST\_VIEW** — был призёром, но исчез из данных
* **PRIZE\_UNCHANGED** — остался призёром, категория не изменилась
* **PRIZE\_UP** — улучшил призовое место (например, с бронзы на золото)
* **PRIZE\_DOWN** — понизил призовое место (например, с золота на бронзу)

### 5. Цвета статусов

* Все цвета для раскраски статусов, а также определение колонок для форматирования — задаются централизованно в `config.py`.
* Для тёмных фонов (темно-серый) текст белый для читаемости.

---

## Варианты запуска

* Все параметры (пути, имена файлов, логику сравнения, цвета, справочники) удобно редактировать в файле `config.py`
* Запуск:

  ```bash
  python Main.py
  ```
* Поддерживается подробное логирование для контроля всех этапов обработки.

---

## Пример результата

![](https://i.imgur.com/v1VXn1n.png)
*Страница “COMPARE” с цветовой индикацией, “STATUS\_LEGEND” — мини-справочник по статусам.*

---

## Расширение/Модификация

* Для добавления новых логик сравнений или цветов статусов:

  * Добавьте новый статус и цвет в `STATUS_COLORS_DICT`
  * Добавьте статус и пояснение в `STATUS_RU_DICT`
  * Если новый столбец для раскраски — добавьте в `STATUS_COLOR_COLUMNS`
* При необходимости расширить логику сравнения — доработайте функцию `make_compare_sheet` в comparer.py

---

## Требования

* Python 3.8+
* pandas
* xlsxwriter

Установка зависимостей:

```bash
pip install pandas xlsxwriter
```

---

## Структура проекта

```
.
├── Main.py
├── config.py
├── comparer.py
├── json_loader.py
├── logging_utils.py
├── README.md
└── ... (ваши входные/выходные папки и файлы)
```

---