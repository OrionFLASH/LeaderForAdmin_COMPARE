---

## Назначение

**Скрипт предназначен для автоматизированного сравнения, анализа и кросс-аналитики изменений в списках лидеров по двум версиям исходных JSON-файлов турниров.**
Результатом является Excel-файл с подробным сравнением, итоговой сводной таблицей по всем сотрудникам и турнирам, цветовой индикацией статусов и лог-файлом с детальным описанием процесса.

---

## Описание процесса

1. **Загрузка данных**

   * Принимает на вход два JSON-файла ("до" и "после").
   * Пути к файлам задаются в начале или через параметры.

2. **Парсинг**

   * Строит плоскую таблицу лидеров по каждому турниру.
   * Вложенные структуры (`divisionRatings`) преобразуются в отдельные колонки с префиксами.
   * Числовые поля переводятся в float/int, строки — к единому формату.

3. **Формирование единой структуры**

   * Колонки обеих таблиц выравниваются (пропущенные добавляются).
   * Ключ сравнения: `(tournamentId, employeeNumber)`.

4. **Сравнение**

   * Находит всех уникальных участников турниров.
   * Для каждой пары рассчитывает статусы изменений по ключевым полям.
   * Для рейтинговых и категориальных полей формируется специальный статус (`NEW`, `REMOVE`, `NO CHANGE`, `UP`, `DOWN`, `NO_RANK` и др.).
   * Для категорий призёра учитываются вход/выход из призовых, ухудшения/улучшения и др.

5. **Фильтрация**

   * В COMPARE попадают только строки, где **хотя бы в одном статусном поле есть изменение** (не "нет изменений").
   * Исключаются строки, где во всех статусных полях только "нулевые" значения (`No Change`, `STAYED_OUT`, `PRIZE_UNCHANGED`, `NO_RANK` и др.).
   * Можно дополнительно фильтровать по нужным турнирам через параметр.

6. **Построение итоговой сводной таблицы (лист FINAL)**

   * Строится кросс-таблица:

     * **Строки** — уникальные сотрудники (`employeeNumber`, `lastName`, `firstName`);
     * **Колонки** — список всех tournamentId (или только из ALLOWED\_TOURNAMENT\_IDS, если задан).
     * **Ячейка на пересечении** — лучший статус категории (BANK/TB/GOSB) с наименьшим ранком (`CATEGORY_RANK_MAP`) для данного сотрудника и турнира.
     * Если нет ни одного значения — в ячейке "Not\_used".
   * Все статусы в этой таблице также окрашиваются по правилам.

7. **Выгрузка**

   * Все этапы логируются (в файл/консоль).
   * В Excel формируются листы: "BEFORE", "AFTER", "COMPARE", "FINAL".
   * Цветовая индикация статусов (`STATUS_COLORS_DICT`).
   * Лог содержит количество строк на каждом этапе, уникальные значения статусов, отладочную информацию по обработке.

---

## Новая задача: Построение итогового листа FINAL

### **Описание**

Реализован автоматический анализ активности сотрудников по всем турнирам в виде кросс-таблицы:

* На пересечении сотрудник–турнир отражается его **лучший статус** по категории BANK/TB/GOSB (выбирается по минимальному рангу из `CATEGORY_RANK_MAP`).
* Если сотрудник не участвовал — ставится статус "Not\_used".
* Список турниров для колонок задаётся параметром ALLOWED\_TOURNAMENT\_IDS, либо определяется по данным автоматически.

### **Исполнение**

* Лист `FINAL_дата` содержит:

  * все уникальные employeeNumber, lastName, firstName (строки);
  * все турниры из ALLOWED\_TOURNAMENT\_IDS (если пуст — из всех данных) (столбцы);
  * в ячейке — минимальный статус из BANK/TB/GOSB, если хотя бы одно поле заполнено, иначе "Not\_used".
* **Раскраска:** используется тот же словарь цветов, что и для листа COMPARE.
* **Логирование:** выводится информация о выбранных статусах, статистика по итоговой таблице, структура финального листа.

---

## Основные функции

* **parse\_json\_file(filepath)**

  * Парсит JSON-файл, строит плоскую таблицу лидеров (одна строка — один участник турнира).
  * Обрабатывает вложенные структуры (`divisionRatings`), отсутствующие/ошибочные поля, добавляет заглушки при отсутствии лидеров.

* **flatten\_leader(leader, tournament, source\_file)**

  * Разворачивает участника турнира в одну плоскую строку, распаковывая вложенные группы.

* **align\_columns(df1, df2)**

  * Делает список столбцов в двух таблицах одинаковым (важно для дальнейшего сравнения).

* **make\_compare\_sheet(df\_before, df\_after, sheet\_name)**

  * Формирует итоговую таблицу сравнения:

    * Строит объединённый DataFrame всех уникальных участников.
    * Для каждого ключевого поля считает статус изменения (выросло/упало/не изменилось/исчезло/добавилось/нет рейтинга).
    * Для категорий призёра учитывает вход/выход из призовых, смену категории.
    * Проставляет статус `"NO_RANK"`, если рейтинг отсутствует в обеих версиях.
    * Логирует число строк до/после этапов, статистику по статусам.
    * Фильтрует строки: в COMPARE попадают только те, где есть **хоть одно** реальное изменение.

* **build\_final\_sheet(compare\_df, allowed\_ids, out\_prefix, category\_rank\_map, log)**

  * Строит кросс-таблицу активности сотрудников по турнирам:

    * Находит все уникальные employeeNumber, lastName, firstName.
    * Для каждого сотрудника по каждому турниру выбирает лучший статус из BANK/TB/GOSB (по минимальному rank), если нет — "Not\_used".
    * Формирует финальный DataFrame, готовый для экспорта в Excel.
    * В логах — все действия, отбор статусов и структура итоговой таблицы.

* **main()**

  * Запускает все этапы, логирует статус обработки, сохраняет итоговый Excel-файл.

---

## Ключевые параметры и настройки

* **ALLOWED\_TOURNAMENT\_IDS** — список кодов турниров, которые включаются в итог (можно оставить пустым для анализа всех).
* **NOCHANGE\_STATUSES** — список "нулевых" статусов (строка попадает в итог только если есть хоть один статус **не** из этого списка).
* **STATUS\_COLORS\_DICT** — словарь цвета для каждого статуса (например, `"NO_RANK": "#EDEDED"`).
* **CATEGORY\_RANK\_MAP** — карта приоритетов для статусов категории (чем меньше значение, тем "выше" ранг; пустое — низший приоритет).
* **PRIORITY\_COLS, COMPARE\_FIELDS, COMPARE\_KEYS** — списки колонок для сортировки и сравнения.
* **Логирование** — подробный лог по каждому этапу (число строк, примеры, ошибки).

---

## Структура проекта

```
.
├── Main.py
├── README.md
├── before.json
├── after.json
├── compare_result.xlsx
├── requirements.txt
└── (остальные ваши файлы/логи)
```

---

## Требования

* Python 3.8+
* pandas
* xlsxwriter

Установка зависимостей:

```bash
pip install pandas xlsxwriter
```

---

## Пример статусов

| Статус               | Значение / Пояснение                      |
| -------------------- | ----------------------------------------- |
| No Change            | Не изменился                              |
| NEW / ADD            | Появился в новой версии                   |
| REMOVE / REMOVE FROM | Был, но исчез                             |
| UP / DOWN            | Значение выросло/упало                    |
| NO\_RANK             | Рейтинг отсутствует в обеих версиях       |
| PRIZE\_UNCHANGED     | Призовая категория не изменилась          |
| STAYED\_OUT          | Вне призовых                              |
| Not\_used            | Сотрудник не участвовал в турнире         |
| ...                  | ... (остальные статусы по логике скрипта) |

---

## Цвета статусов (пример)

```python
STATUS_COLORS_DICT = {
    "No Change": "#FFFFFF",
    "NEW": "#B7E1CD",
    "REMOVE": "#F4CCCC",
    "UP": "#A4C2F4",
    "DOWN": "#F9CB9C",
    "NO_RANK": "#EDEDED",      # Светло-серый (отсутствует рейтинг)
    "Not_used": "#F5F5F5",     # Еще более светло-серый (не участвовал)
    "PRIZE_UNCHANGED": "#D9D9D9",
    "STAYED_OUT": "#EEEEEE",
    # ... остальные статусы ...
}
```

---

# Техническое задание (ТЗ)

---

## 1. **Парсинг и обработка JSON-файлов турниров**

* Входной файл — JSON с ключом `tournamentId` и данными по турниру/лидерам.
* Обработка вложенных структур, поддержка разных типов (`list`, `dict`).
* Числовые поля устойчиво приводятся к нужному типу.
* Если лидеры отсутствуют — добавлять заглушку.

---

## 2. **Сравнение файлов**

* Сравнение по ключу `(tournamentId, employeeNumber)`.
* Для каждого поля сравнения рассчитывать статус (`NEW`, `REMOVE`, `UP`, `DOWN`, `NO_RANK` и др.).
* Для категорий призёра сравнивать переходы, улучшения, ухудшения.
* В итоговый COMPARE попадают только строки с реальными изменениями (см. фильтр выше).
* Добавить отдельную фильтрацию по списку турниров (`ALLOWED_TOURNAMENT_IDS`).

---

## 3. **Построение итогового листа FINAL**

* Сформировать кросс-таблицу по всем сотрудникам и турнирам:

  * строки: все уникальные `employeeNumber`, `lastName`, `firstName`;
  * колонки: все турниры (или только ALLOWED\_TOURNAMENT\_IDS);
  * в ячейках: лучший статус по BANK/TB/GOSB, если нет — "Not\_used".
* Наименьший rank по CATEGORY\_RANK\_MAP считается лучшим.
* Все ячейки, содержащие статусы, окрашиваются согласно STATUS\_COLORS\_DICT.
* Итоговый лист FINAL экспортируется в общий Excel-файл, с датой и названием листа "FINAL\_дата".

---

## 4. **Логирование и отладка**

* Подробный лог по всем этапам.
* Фиксация количества строк на каждом этапе.
* Примеры значений статусов.
* Отдельный лог ошибок (ошибки не прерывают обработку).
* В процессе построения FINAL — логируется выбор статуса для каждой ячейки.

---

## 5. **Результат**

* Excel-файл с листами: "BEFORE", "AFTER", "COMPARE", "FINAL".
* Поддержка цветовой индикации по статусу.
* Готовность файла для анализа в Excel.

---

## 6. **Расширяемость**

* Любой новый статус, цвет, дополнительное поле легко добавить через параметры в начале файла (например, в NOCHANGE\_STATUSES, STATUS\_COLORS\_DICT, CATEGORY\_RANK\_MAP).
* Логику сравнения/фильтрации и кросс-аналитики можно доработать централизованно, не меняя основной алгоритм.

---

# Инструкция по запуску

1. **Подготовьте файлы:**
   — исходные `before.json` и `after.json`

2. **Настройте параметры** в начале `Main.py`:
   — список турниров, статусные поля, нужные "нулевые" статусы, цвета и ранги статусов

3. **Запустите:**

```bash
python Main.py
```

4. **Откройте `compare_result.xlsx`** — все отличия, статусы изменений, итоговая кросс-таблица по турнирам и сотрудникам.

---

## Примеры кода функций (фрагменты)

```python
def parse_json_file(filepath):
    ...
    # Чтение и преобразование JSON в плоскую таблицу

def make_compare_sheet(df_before, df_after, sheet_name):
    ...
    # Сравнение, проставление статусов, фильтрация, логирование

def build_final_sheet(compare_df, allowed_ids, out_prefix, category_rank_map, log):
    ...
    # Кросс-таблица: выбор лучшего статуса, Not_used, логика и логирование

def is_any_change(row):
    for col in status_cols:
        val = str(row.get(col, "")).strip()
        if val not in NOCHANGE_STATUSES and not (val.startswith("Rang") and "NO CHANGE" in val):
            return True
    return False
# Фильтрация:
mask = compare_df.apply(is_any_change, axis=1)
compare_df = compare_df[mask].reset_index(drop=True)
```

---